# --- Imports ---
import os
import json
import logging
import time
import uuid
import secrets
import requests
from flask import Flask, Response, request, session, jsonify, redirect, url_for, render_template_string
from flask_login import LoginManager, UserMixin, login_user, logout_user, current_user, login_required
from datetime import datetime, date, timedelta
from werkzeug.security import generate_password_hash, check_password_hash
from functools import wraps
from dotenv import load_dotenv
import stripe
from itsdangerous import URLSafeTimedSerializer, SignatureExpired, BadTimeSignature
from flask_mail import Mail, Message
from flask_talisman import Talisman
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import event, or_, func, desc
from sqlalchemy.orm import joinedload
from sqlalchemy.exc import IntegrityError, SQLAlchemyError
from flask_wtf.csrf import CSRFProtect
from flask_socketio import SocketIO, emit, join_room, leave_room
from flask_cors import CORS
from sqlalchemy.engine import Engine
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address

# ==============================================================================
# --- 1. INITIAL CONFIGURATION & SETUP ---
# ==============================================================================
load_dotenv()
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

app = Flask(__name__)

# --- App Configuration ---
app.config['SQLALCHEMY_DATABASE_URI'] = os.environ.get('DATABASE_URL', 'sqlite:///database.db')
app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'a-very-secret-key-for-dev')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['SECURITY_PASSWORD_SALT'] = os.environ.get('SECURITY_PASSWORD_SALT', 'a-fallback-salt-for-dev')
is_production = os.environ.get('FLASK_ENV') == 'production'
app.config['SESSION_COOKIE_SECURE'] = is_production
app.config['REMEMBER_COOKIE_SECURE'] = is_production
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['REMEMBER_COOKIE_HTTPONLY'] = True

# --- Security, CORS, and Rate Limiting ---
CORS(app, supports_credentials=True, origins="*")
csrf = CSRFProtect(app)
limiter = Limiter(get_remote_address, app=app, default_limits=["200 per day", "50 per hour"])

csp = {
    'default-src': '\'self\'',
    'script-src': ['\'self\'', 'https://cdn.tailwindcss.com', 'https://cdnjs.cloudflare.com', 'https://js.stripe.com'],
    'style-src': ['\'self\'', '\'unsafe-inline\'', 'https://cdn.tailwindcss.com', 'https://fonts.googleapis.com'],
    'font-src': ['\'self\'', 'https://fonts.gstatic.com'],
    'img-src': '*',
    'connect-src': '\'self\''
}
Talisman(app, content_security_policy=csp)

# --- Site-wide Configuration Dictionary ---
SITE_CONFIG = {
    "STRIPE_SECRET_KEY": os.environ.get('STRIPE_SECRET_KEY'),
    "STRIPE_PUBLIC_KEY": os.environ.get('STRIPE_PUBLIC_KEY'),
    "STRIPE_STUDENT_PRICE_ID": os.environ.get('STRIPE_STUDENT_PRICE_ID'),
    "STRIPE_STUDENT_PRO_PRICE_ID": os.environ.get('STRIPE_STUDENT_PRO_PRICE_ID'),
    "YOUR_DOMAIN": os.environ.get('YOUR_DOMAIN', 'http://localhost:5000'),
    "SECRET_TEACHER_KEY": os.environ.get('SECRET_TEACHER_KEY', 'SUPER-SECRET-TEACHER-KEY'),
    "ADMIN_SECRET_KEY": os.environ.get('ADMIN_SECRET_KEY', 'SUPER-SECRET-ADMIN-KEY'),
    "STRIPE_WEBHOOK_SECRET": os.environ.get('STRIPE_WEBHOOK_SECRET'),
}

# --- Initialize Extensions with the App ---
stripe.api_key = SITE_CONFIG.get("STRIPE_SECRET_KEY")
password_reset_serializer = URLSafeTimedSerializer(app.config['SECRET_KEY'])
db = SQLAlchemy(app)
socketio = SocketIO(app, cors_allowed_origins="*")
mail = Mail(app)

app.config.update(
    MAIL_SERVER=os.environ.get('MAIL_SERVER'),
    MAIL_PORT=int(os.environ.get('MAIL_PORT', 587)),
    MAIL_USE_TLS=os.environ.get('MAIL_USE_TLS', 'true').lower() == 'true',
    MAIL_USERNAME=os.environ.get('MAIL_USERNAME'),
    MAIL_PASSWORD=os.environ.get('MAIL_PASSWORD'),
    MAIL_DEFAULT_SENDER=os.environ.get('MAIL_SENDER')
)

@app.teardown_appcontext
def shutdown_session(exception=None):
    db.session.remove()

# ==============================================================================
# --- 2. DATABASE MODELS ---
# ==============================================================================
@event.listens_for(Engine, "connect")
def set_sqlite_pragma(dbapi_connection, connection_record):
    if app.config['SQLALCHEMY_DATABASE_URI'].startswith('sqlite'):
        cursor = dbapi_connection.cursor()
        cursor.execute("PRAGMA foreign_keys=ON")
        cursor.close()

student_class_association = db.Table('student_class_association',
    db.Column('user_id', db.String(36), db.ForeignKey('user.id', ondelete='CASCADE'), primary_key=True),
    db.Column('class_id', db.String(36), db.ForeignKey('class.id', ondelete='CASCADE'), primary_key=True)
)
team_member_association = db.Table('team_member_association',
    db.Column('user_id', db.String(36), db.ForeignKey('user.id', ondelete='CASCADE'), primary_key=True),
    db.Column('team_id', db.String(36), db.ForeignKey('team.id', ondelete='CASCADE'), primary_key=True)
)

class User(UserMixin, db.Model):
    id = db.Column(db.String(36), primary_key=True, default=lambda: str(uuid.uuid4()))
    username = db.Column(db.String(80), unique=True, nullable=False, index=True)
    email = db.Column(db.String(120), unique=True, nullable=False, index=True)
    password_hash = db.Column(db.String(256), nullable=True)
    role = db.Column(db.String(20), nullable=False, default='student')
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    has_subscription = db.Column(db.Boolean, default=False)
    stripe_customer_id = db.Column(db.String(120), nullable=True, index=True)
    theme_preference = db.Column(db.String(50), nullable=True, default='dark')
    profile = db.relationship('Profile', back_populates='user', uselist=False, cascade="all, delete-orphan")
    taught_classes = db.relationship('Class', back_populates='teacher', lazy=True, foreign_keys='Class.teacher_id', cascade="all, delete-orphan")
    enrolled_classes = db.relationship('Class', secondary=student_class_association, back_populates='students', lazy='dynamic')
    teams = db.relationship('Team', secondary=team_member_association, back_populates='members', lazy='dynamic')
    submissions = db.relationship('Submission', back_populates='student', lazy=True, cascade="all, delete-orphan")
    quiz_attempts = db.relationship('QuizAttempt', back_populates='student', lazy=True, cascade="all, delete-orphan")
    notifications = db.relationship('Notification', back_populates='user', lazy=True, cascade="all, delete-orphan")
    def to_dict(self):
        profile_data = {'bio': '', 'avatar': ''}
        if self.profile:
            profile_data['bio'] = self.profile.bio or ''
            profile_data['avatar'] = self.profile.avatar or ''
        return {'id': self.id, 'username': self.username, 'email': self.email, 'role': self.role, 'created_at': self.created_at.isoformat(), 'has_subscription': self.has_subscription, 'profile': profile_data, 'theme_preference': self.theme_preference}

class Profile(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.String(36), db.ForeignKey('user.id', ondelete='CASCADE'), nullable=False, unique=True)
    bio = db.Column(db.Text, nullable=True)
    avatar = db.Column(db.String(500), nullable=True)
    user = db.relationship('User', back_populates='profile')

class Team(db.Model):
    id = db.Column(db.String(36), primary_key=True, default=lambda: str(uuid.uuid4()))
    name = db.Column(db.String(100), nullable=False)
    code = db.Column(db.String(8), unique=True, nullable=False, index=True)
    owner_id = db.Column(db.String(36), db.ForeignKey('user.id'), nullable=False, index=True)
    owner = db.relationship('User', foreign_keys=[owner_id])
    members = db.relationship('User', secondary=team_member_association, back_populates='teams', lazy='dynamic')

class Class(db.Model):
    id = db.Column(db.String(36), primary_key=True, default=lambda: str(uuid.uuid4()))
    name = db.Column(db.String(100), nullable=False)
    code = db.Column(db.String(8), unique=True, nullable=False, index=True)
    teacher_id = db.Column(db.String(36), db.ForeignKey('user.id'), nullable=False, index=True)
    teacher = db.relationship('User', back_populates='taught_classes', foreign_keys=[teacher_id])
    students = db.relationship('User', secondary=student_class_association, back_populates='enrolled_classes', lazy='dynamic')
    messages = db.relationship('ChatMessage', back_populates='class_obj', lazy=True, cascade="all, delete-orphan")
    assignments = db.relationship('Assignment', back_populates='class_obj', lazy=True, cascade="all, delete-orphan")
    quizzes = db.relationship('Quiz', back_populates='class_obj', lazy=True, cascade="all, delete-orphan")

class ChatMessage(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    class_id = db.Column(db.String(36), db.ForeignKey('class.id', ondelete='CASCADE'), nullable=False)
    sender_id = db.Column(db.String(36), db.ForeignKey('user.id'), nullable=True)
    content = db.Column(db.Text, nullable=False)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)
    class_obj = db.relationship('Class', back_populates='messages')
    sender = db.relationship('User')

class Assignment(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    class_id = db.Column(db.String(36), db.ForeignKey('class.id', ondelete='CASCADE'), nullable=False)
    title = db.Column(db.String(200), nullable=False)
    description = db.Column(db.Text, nullable=False)
    due_date = db.Column(db.DateTime, nullable=False)
    class_obj = db.relationship('Class', back_populates='assignments')
    submissions = db.relationship('Submission', back_populates='assignment', lazy='dynamic', cascade="all, delete-orphan")

class Submission(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    assignment_id = db.Column(db.Integer, db.ForeignKey('assignment.id', ondelete='CASCADE'), nullable=False)
    student_id = db.Column(db.String(36), db.ForeignKey('user.id', ondelete='CASCADE'), nullable=False)
    content = db.Column(db.Text, nullable=False)
    grade = db.Column(db.Float, nullable=True)
    feedback = db.Column(db.Text, nullable=True)
    submitted_at = db.Column(db.DateTime, default=datetime.utcnow)
    assignment = db.relationship('Assignment', back_populates='submissions')
    student = db.relationship('User', back_populates='submissions')

class Quiz(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    class_id = db.Column(db.String(36), db.ForeignKey('class.id', ondelete='CASCADE'), nullable=False)
    title = db.Column(db.String(200), nullable=False)
    description = db.Column(db.Text, nullable=True)
    time_limit = db.Column(db.Integer, nullable=False)
    class_obj = db.relationship('Class', back_populates='quizzes')
    questions = db.relationship('Question', back_populates='quiz', lazy=True, cascade="all, delete-orphan")
    attempts = db.relationship('QuizAttempt', back_populates='quiz', lazy='dynamic', cascade="all, delete-orphan")

class Question(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    quiz_id = db.Column(db.Integer, db.ForeignKey('quiz.id', ondelete='CASCADE'), nullable=False)
    text = db.Column(db.Text, nullable=False)
    question_type = db.Column(db.String(50), nullable=False, default='multiple_choice')
    quiz = db.relationship('Quiz', back_populates='questions')
    choices = db.Column(db.JSON, nullable=False)

class QuizAttempt(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    quiz_id = db.Column(db.Integer, db.ForeignKey('quiz.id', ondelete='CASCADE'), nullable=False)
    student_id = db.Column(db.String(36), db.ForeignKey('user.id', ondelete='CASCADE'), nullable=False)
    score = db.Column(db.Float, nullable=True)
    start_time = db.Column(db.DateTime, default=datetime.utcnow)
    end_time = db.Column(db.DateTime, nullable=True)
    answers = db.Column(db.JSON, nullable=True)
    quiz = db.relationship('Quiz', back_populates='attempts')
    student = db.relationship('User', back_populates='quiz_attempts')

class Notification(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.String(36), db.ForeignKey('user.id', ondelete='CASCADE'), nullable=False)
    content = db.Column(db.String(500), nullable=False)
    is_read = db.Column(db.Boolean, default=False)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)
    user = db.relationship('User', back_populates='notifications')

class SiteSettings(db.Model):
    key = db.Column(db.String(50), primary_key=True)
    value = db.Column(db.String(500))

class BackgroundMusic(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    url = db.Column(db.String(500), nullable=False)
    uploaded_by = db.Column(db.String(36), db.ForeignKey('user.id'), nullable=False)

# ==============================================================================
# --- 3. USER & SESSION MANAGEMENT ---
# ==============================================================================
login_manager = LoginManager()
login_manager.init_app(app)

@login_manager.user_loader
def load_user(user_id): return User.query.get(user_id)

@login_manager.unauthorized_handler
def unauthorized(): return jsonify({"error": "Login required.", "logged_in": False}), 401

def role_required(role_name):
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not current_user.is_authenticated: return jsonify({"error": "Login required."}), 401
            if current_user.role != role_name and current_user.role != 'admin': return jsonify({"error": f"{role_name.capitalize()} access required."}), 403
            return f(*args, **kwargs)
        return decorated_function
    return decorator

admin_required = role_required('admin')
teacher_required = role_required('teacher')

# ==============================================================================
# --- 4. FRONTEND & CORE ROUTES ---
# ==============================================================================
HTML_CONTENT = """
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Myth AI Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="/favicon.ico">
    <style>
        :root {
            --brand-hue: 220; --bg-dark: #0F172A; --bg-med: #1E293B; --bg-light: #334155;
            --glow-color: hsl(var(--brand-hue), 100%, 70%); --text-color: #E2E8F0; --text-secondary-color: #94A3B8;
        }
        body { background-color: var(--bg-dark); font-family: 'Inter', sans-serif; color: var(--text-color); }
        .glassmorphism { background: rgba(31, 41, 55, 0.5); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .brand-gradient-text { background-image: linear-gradient(120deg, hsl(var(--brand-hue), 90%, 60%), hsl(var(--brand-hue), 90%, 65%)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .brand-gradient-bg { background-image: linear-gradient(120deg, hsl(var(--brand-hue), 90%, 55%), hsl(var(--brand-hue), 90%, 60%)); }
        .shiny-button { transition: all 0.3s ease; box-shadow: 0 0 5px rgba(0,0,0,0.5), 0 0 10px var(--glow-color, #fff) inset; }
        .shiny-button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px hsla(var(--brand-hue), 80%, 50%, 0.4), 0 0 5px var(--glow-color, #fff) inset; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; } @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .active-tab { background-color: var(--bg-light) !important; color: white !important; position:relative; }
        .active-tab::after { content: ''; position: absolute; bottom: 0; left: 10%; width: 80%; height: 2px; background: var(--glow-color); border-radius: 2px; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .ai-message .chat-bubble { background-color: #2E1A47; border-color: #8B5CF6; }
        .user-message .chat-bubble { background-color: #1E40AF; border-color: #3B82F6; }
        .dynamic-bg { background: linear-gradient(-45deg, #0f172a, #1e3a8a, #4c1d95, #0f172a); background-size: 400% 400%; animation: gradientBG 20s ease infinite; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .full-screen-loader { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 1001; transition: opacity 0.3s ease; }
        .loader-dots { display: flex; gap: 1rem; }
        .loader-dots div { width: 1rem; height: 1rem; background-color: hsl(var(--brand-hue), 90%, 60%); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .loader-dots .dot1 { animation-delay: -0.32s; }
        .loader-dots .dot2 { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .waiting-text { margin-top: 2rem; font-size: 1.25rem; color: var(--text-secondary-color); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        /* Custom styles for quiz and assignment modals */
        .input-field { background-color: rgba(30, 41, 59, 0.8); border: 1px solid #475569; border-radius: 0.5rem; padding: 0.75rem; width: 100%; }
        .input-field:focus { outline: none; border-color: hsl(var(--brand-hue), 90%, 60%); }
        .label-text { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    </style>
</head>
<body class="text-gray-200 antialiased">
    <div id="app-container" class="relative h-screen w-screen overflow-hidden flex flex-col"></div>
    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-2"></div>
    <div id="modal-container"></div>
    <div class="fixed bottom-4 left-4 text-xs text-gray-500">&copy; <span id="current-year"></span> Myth AI</div>
    <audio id="background-music" loop autoplay></audio>

    <template id="template-full-screen-loader"><div class="full-screen-loader fade-in"><div class="loader-dots"><div class="dot1"></div><div class="dot2"></div><div class="dot3"></div></div><div class="waiting-text">Preparing your adventure...</div></div></template>
    <template id="template-role-choice"><div class="flex flex-col items-center justify-center h-full w-full p-4 fade-in dynamic-bg"><div class="w-full max-w-md text-center"><div class="flex items-center justify-center gap-3 mb-4"><div id="logo-container-role" class="h-16 w-16"></div><h1 class="text-5xl font-bold brand-gradient-text">Myth AI</h1></div><p class="text-gray-400 text-lg mb-10">Select your role to continue</p><div class="space-y-4"><button data-role="student" class="role-btn w-full text-left p-6 glassmorphism rounded-lg flex items-center justify-between transition-all hover:border-blue-400 border border-transparent"><div><h2 class="text-xl font-bold text-white">Student Portal</h2><p class="text-gray-400">Join classes, submit assignments, and learn with AI.</p></div><span class="text-2xl">&rarr;</span></button><button data-role="teacher" class="role-btn w-full text-left p-6 glassmorphism rounded-lg flex items-center justify-between transition-all hover:border-purple-400 border border-transparent"><div><h2 class="text-xl font-bold text-white">Teacher Portal</h2><p class="text-gray-400">Create classes, manage students, and assign quizzes.</p></div><span class="text-2xl">&rarr;</span></button><button data-role="admin" class="role-btn w-full text-left p-6 glassmorphism rounded-lg flex items-center justify-between transition-all hover:border-red-400 border border-transparent"><div><h2 class="text-xl font-bold text-white">Admin Portal</h2><p class="text-gray-400">Manage users, classes, and site settings.</p></div><span class="text-2xl">&rarr;</span></button></div></div></div></template>
    <template id="template-main-dashboard"><div class="flex h-full w-full bg-gray-800 fade-in"><nav class="w-64 bg-gray-900/70 backdrop-blur-sm p-6 flex flex-col gap-4 flex-shrink-0 border-r border-white/10"><div class="flex items-center gap-3 mb-6"><div id="logo-container-dash" class="h-8 w-8"></div><h2 class="text-2xl font-bold brand-gradient-text" id="dashboard-title">Portal</h2></div><div id="nav-links" class="flex flex-col gap-2"></div><div class="mt-auto flex flex-col gap-4"><div id="adsense-container" class="w-full h-48 bg-gray-700/50 rounded-lg flex items-center justify-center text-gray-500 text-sm">Ad Placeholder</div><div id="notification-bell-container" class="relative"></div><button id="logout-btn" class="bg-red-600/50 hover:bg-red-600 border border-red-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Logout</button></div></nav><main class="flex-1 p-8 overflow-y-auto"><div id="dashboard-content"></div></main></div></template>
    <template id="template-auth-form"><div class="flex flex-col items-center justify-center h-full w-full p-4 fade-in dynamic-bg"><div class="w-full max-w-md glassmorphism rounded-2xl p-8 shadow-2xl"><button id="back-to-roles" class="text-sm text-blue-400 hover:text-blue-300 mb-4">&larr; Back to Role Selection</button><h1 class="text-3xl font-bold text-center brand-gradient-text mb-2" id="auth-title">Portal Login</h1><p class="text-gray-400 text-center mb-6" id="auth-subtitle">Sign in to continue</p><form id="auth-form"><input type="hidden" id="account_type" name="account_type" value="student"><div id="email-field" class="hidden mb-4"><label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email</label><input type="email" id="email" name="email" class="w-full p-3 bg-gray-700/50 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div class="mb-4"><label for="username" class="block text-sm font-medium text-gray-300 mb-1">Username</label><input type="text" id="username" name="username" class="w-full p-3 bg-gray-700/50 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required></div><div class="mb-4"><label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label><input type="password" id="password" name="password" class="w-full p-3 bg-gray-700/50 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" required></div><div id="teacher-key-field" class="hidden mb-4"><label for="teacher-secret-key" class="block text-sm font-medium text-gray-300 mb-1">Secret Teacher Key</label><input type="text" id="teacher-secret-key" name="secret_key" class="w-full p-3 bg-gray-700/50 rounded-lg border border-gray-600" placeholder="Required for teacher sign up"></div><div id="admin-key-field" class="hidden mb-4"><label for="admin-secret-key" class="block text-sm font-medium text-gray-300 mb-1">Secret Admin Key</label><input type="password" id="admin-secret-key" name="admin_secret_key" class="w-full p-3 bg-gray-700/50 rounded-lg border border-gray-600" placeholder="Required for admin login"></div><div class="flex justify-end mb-6"><button type="button" id="forgot-password-link" class="text-xs text-blue-400 hover:text-blue-300">Forgot Password?</button></div><button type="submit" id="auth-submit-btn" class="w-full brand-gradient-bg shiny-button text-white font-bold py-3 px-4 rounded-lg transition-opacity">Login</button><p id="auth-error" class="text-red-400 text-sm text-center h-4 mt-3"></p></form><div class="text-center mt-6"><button id="auth-toggle-btn" class="text-sm text-blue-400 hover:text-blue-300">Don't have an account? <span class="font-semibold">Sign Up</span></button></div></div></div></template>
    <template id="template-my-classes"><h3 class="text-3xl font-bold text-white mb-6">My Classes</h3><div id="class-action-container" class="mb-6"></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="classes-list"></div><div id="selected-class-view" class="mt-8 hidden"></div></template>
    <template id="template-team-mode"><h3 class="text-3xl font-bold text-white mb-6">Team Mode</h3><div id="team-action-container" class="mb-6"></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="teams-list"></div><div id="selected-team-view" class="mt-8 hidden"></div></template>
    <template id="template-student-class-action"><div class="glassmorphism p-4 rounded-lg"><h4 class="font-semibold text-lg mb-2 text-white">Join a New Class</h4><div class="flex items-center gap-2"><input type="text" id="class-code" placeholder="Enter class code" class="flex-grow p-3 bg-gray-700/50 rounded-lg border border-gray-600"><button id="join-class-btn" class="brand-gradient-bg shiny-button text-white font-bold py-3 px-4 rounded-lg">Join</button></div></div></template>
    <template id="template-teacher-class-action"><div class="glassmorphism p-4 rounded-lg"><h4 class="font-semibold text-lg mb-2 text-white">Create a New Class</h4><div class="flex items-center gap-2"><input type="text" id="new-class-name" name="name" placeholder="New class name" class="flex-grow p-3 bg-gray-700/50 rounded-lg border border-gray-600"><button id="create-class-btn" class="brand-gradient-bg shiny-button text-white font-bold py-3 px-4 rounded-lg">Create</button></div></div></template>
    <template id="template-team-actions"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="glassmorphism p-4 rounded-lg"><h4 class="font-semibold text-lg mb-2 text-white">Join a Team</h4><div class="flex items-center gap-2"><input type="text" id="team-code" placeholder="Enter team code" class="flex-grow p-3 bg-gray-700/50 rounded-lg border border-gray-600"><button id="join-team-btn" class="brand-gradient-bg shiny-button text-white font-bold py-3 px-4 rounded-lg">Join</button></div></div><div class="glassmorphism p-4 rounded-lg"><h4 class="font-semibold text-lg mb-2 text-white">Create a New Team</h4><div class="flex items-center gap-2"><input type="text" id="new-team-name" placeholder="New team name" class="flex-grow p-3 bg-gray-700/50 rounded-lg border border-gray-600"><button id="create-team-btn" class="brand-gradient-bg shiny-button text-white font-bold py-3 px-4 rounded-lg">Create</button></div></div></div></template>
    <template id="template-selected-class-view"><div class="glassmorphism p-6 rounded-lg"><div class="flex justify-between items-start"><h4 class="text-2xl font-bold text-white mb-4">Class: <span id="selected-class-name"></span></h4><button id="back-to-classes-btn" class="text-sm text-blue-400 hover:text-blue-300">&larr; Back to All Classes</button></div><div class="flex border-b border-gray-600 mb-4 overflow-x-auto"><button class="py-2 px-4 text-gray-300 hover:text-white class-view-tab whitespace-nowrap" data-tab="chat">Chat</button><button class="py-2 px-4 text-gray-300 hover:text-white class-view-tab whitespace-nowrap" data-tab="assignments">Assignments</button><button class="py-2 px-4 text-gray-300 hover:text-white class-view-tab whitespace-nowrap" data-tab="quizzes">Quizzes</button><button class="py-2 px-4 text-gray-300 hover:text-white class-view-tab whitespace-nowrap" data-tab="students">Students</button></div><div id="class-view-content"></div></div></template>
    <template id="template-class-chat-view"><div id="chat-messages" class="bg-gray-900/50 p-4 rounded-lg h-96 overflow-y-auto mb-4 border border-gray-700 flex flex-col gap-4"></div><form id="chat-form" class="flex items-center gap-2"><input type="text" id="chat-input" placeholder="Ask the AI assistant or type an admin command..." class="flex-grow w-full p-3 bg-gray-700/50 rounded-lg border border-gray-600"><button type="submit" id="send-chat-btn" class="brand-gradient-bg shiny-button text-white font-bold py-3 px-4 rounded-lg">Send</button></form></template>
    <template id="template-class-assignments-view"><div class="flex justify-between items-center mb-4"><h5 class="text-xl font-semibold text-white">Assignments</h5><div id="assignment-action-container"></div></div><div id="assignments-list" class="space-y-4"></div></template>
    <template id="template-class-quizzes-view"><div class="flex justify-between items-center mb-4"><h5 class="text-xl font-semibold text-white">Quizzes</h5><div id="quiz-action-container"></div></div><div id="quizzes-list" class="space-y-4"></div></template>
    <template id="template-class-students-view"><h5 class="text-xl font-semibold text-white mb-4">Enrolled Students</h5><ul id="class-students-list" class="space-y-2"></ul></template>
    <template id="template-profile"><h3 class="text-3xl font-bold text-white mb-6">Customize Profile</h3><form id="profile-form" class="glassmorphism p-6 rounded-lg max-w-lg"><div class="mb-4"><label for="bio" class="block text-sm font-medium text-gray-300 mb-1">Bio</label><textarea id="bio" name="bio" class="w-full p-3 bg-gray-700/50 rounded-lg border border-gray-600" rows="4"></textarea></div><div class="mb-4"><label for="avatar" class="block text-sm font-medium text-gray-300 mb-1">Avatar URL</label><input type="url" id="avatar" name="avatar" class="w-full p-3 bg-gray-700/50 rounded-lg border border-gray-600"></div><button type="submit" class="brand-gradient-bg shiny-button text-white font-bold py-2 px-4 rounded-lg">Save Profile</button></form></template>
    <template id="template-billing"><h3 class="text-3xl font-bold text-white mb-6">Billing & Plans</h3><div id="billing-content" class="glassmorphism p-6 rounded-lg"></div></template>
    <template id="template-admin-dashboard"><h3 class="text-3xl font-bold text-white mb-6">Admin Panel</h3><div id="admin-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></div><div class="flex border-b border-gray-600 mb-4 overflow-x-auto"><button class="py-2 px-4 text-gray-300 hover:text-white admin-view-tab whitespace-nowrap" data-tab="users">Users</button><button class="py-2 px-4 text-gray-300 hover:text-white admin-view-tab whitespace-nowrap" data-tab="classes">Classes</button><button class="py-2 px-4 text-gray-300 hover:text-white admin-view-tab whitespace-nowrap" data-tab="settings">Settings</button><button class="py-2 px-4 text-gray-300 hover:text-white admin-view-tab whitespace-nowrap" data-tab="music">Music</button></div><div id="admin-view-content"></div></template>
    <template id="template-admin-users-view"><h4 class="text-xl font-bold text-white mb-4">User Management</h4><div class="overflow-x-auto glassmorphism p-4 rounded-lg"><table class="w-full text-left text-sm text-gray-300"><thead><tr class="border-b border-gray-600"><th class="p-3">Username</th><th class="p-3">Email</th><th class="p-3">Role</th><th class="p-3">Created At</th><th class="p-3">Actions</th></tr></thead><tbody id="admin-user-list" class="divide-y divide-gray-700/50"></tbody></table></div></template>
    <template id="template-admin-classes-view"><h4 class="text-xl font-bold text-white mb-4">Class Management</h4><div class="overflow-x-auto glassmorphism p-4 rounded-lg"><table class="w-full text-left text-sm text-gray-300"><thead><tr class="border-b border-gray-600"><th class="p-3">Name</th><th class="p-3">Teacher</th><th class="p-3">Code</th><th class="p-3">Students</th><th class="p-3">Actions</th></tr></thead><tbody id="admin-class-list" class="divide-y divide-gray-700/50"></tbody></table></div></template>
    <template id="template-admin-settings-view"><h4 class="text-xl font-bold text-white mb-4">Site Settings</h4><form id="admin-settings-form" class="glassmorphism p-6 rounded-lg max-w-lg"><div class="mb-4"><label for="setting-announcement" class="block text-sm font-medium text-gray-300 mb-1">Announcement Banner</label><input type="text" id="setting-announcement" name="announcement" class="w-full p-3 bg-gray-700/50 rounded-lg border border-gray-600"></div><div class="mb-4"><label for="setting-daily-message" class="block text-sm font-medium text-gray-300 mb-1">Message of the Day</label><input type="text" id="setting-daily-message" name="daily_message" class="w-full p-3 bg-gray-700/50 rounded-lg border border-gray-600"></div><div class="mb-4"><label for="ai-persona-input" class="block text-sm font-medium text-gray-300 mb-1">AI Persona</label><input type="text" id="ai-persona-input" name="ai_persona" class="w-full p-3 bg-gray-700/50 rounded-lg border border-gray-600" placeholder="e.g. A helpful study guide"></div><div class="mb-4"><label class="block text-sm font-medium text-gray-300 mb-1">Maintenance Mode</label><button type="button" id="maintenance-toggle-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Toggle Maintenance Mode</button></div><button type="submit" class="brand-gradient-bg shiny-button text-white font-bold py-2 px-4 rounded-lg">Save Settings</button></form></template>
    <template id="template-admin-music-view"><h4 class="text-xl font-bold text-white mb-4">Background Music</h4><div class="flex items-center gap-2 mb-4"><input type="text" id="music-name" placeholder="Music Title" class="flex-grow p-3 bg-gray-700/50 rounded-lg border border-gray-600"><input type="url" id="music-url" placeholder="Music URL (MP3)" class="flex-grow p-3 bg-gray-700/50 rounded-lg border border-gray-600"><button id="add-music-btn" class="brand-gradient-bg shiny-button text-white font-bold py-3 px-4 rounded-lg">Add Music</button></div><ul id="music-list" class="space-y-2"></ul></template>
    <template id="template-modal"><div class="modal-overlay"><div class="glassmorphism rounded-2xl p-8 shadow-2xl w-full max-w-2xl modal-content relative"><button class="absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button><div class="modal-body"></div></div></div></template>
    
    <template id="template-create-assignment-modal">
        <form id="create-assignment-form">
            <h2 class="text-2xl font-bold text-white mb-6">New Assignment</h2>
            <div class="mb-4">
                <label class="label-text" for="assignment-title">Title</label>
                <input type="text" id="assignment-title" name="title" class="input-field" required>
            </div>
            <div class="mb-4">
                <label class="label-text" for="assignment-description">Description</label>
                <textarea id="assignment-description" name="description" class="input-field" rows="5" required></textarea>
            </div>
            <div class="mb-6">
                <label class="label-text" for="assignment-due-date">Due Date</label>
                <input type="datetime-local" id="assignment-due-date" name="due_date" class="input-field" required>
            </div>
            <button type="submit" class="w-full brand-gradient-bg shiny-button text-white font-bold py-3 px-4 rounded-lg">Create Assignment</button>
        </form>
    </template>

    <template id="template-view-assignment-modal">
        <div id="assignment-details-content" class="text-left">
            </div>
    </template>
    
    <template id="template-create-quiz-modal">
        <form id="create-quiz-form">
            <h2 class="text-2xl font-bold text-white mb-6">New Quiz</h2>
            <div class="mb-4">
                <label class="label-text" for="quiz-title">Quiz Title</label>
                <input type="text" id="quiz-title" name="title" class="input-field" required>
            </div>
            <div class="mb-4">
                <label class="label-text" for="quiz-description">Description</label>
                <textarea id="quiz-description" name="description" class="input-field" rows="3"></textarea>
            </div>
            <div class="mb-4">
                <label class="label-text" for="quiz-time-limit">Time Limit (Minutes)</label>
                <input type="number" id="quiz-time-limit" name="time_limit" class="input-field" min="1" required>
            </div>
            <h3 class="text-xl font-semibold text-white mt-6 mb-4">Questions</h3>
            <div id="questions-container" class="space-y-6">
                </div>
            <div class="flex justify-between mt-6">
                <button type="button" id="add-question-btn" class="bg-blue-600/50 hover:bg-blue-600 border border-blue-500 text-white font-bold py-2 px-4 rounded-lg">Add Question</button>
                <button type="submit" class="brand-gradient-bg shiny-button text-white font-bold py-3 px-4 rounded-lg">Create Quiz</button>
            </div>
        </form>
    </template>

    <template id="template-take-quiz-modal">
        <div id="quiz-take-content">
             </div>
    </template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const BASE_URL = '';
        const SITE_CONFIG = {
            STRIPE_PUBLIC_KEY: '{{ SITE_CONFIG.STRIPE_PUBLIC_KEY }}',
            STRIPE_STUDENT_PRO_PRICE_ID: '{{ SITE_CONFIG.STRIPE_STUDENT_PRO_PRICE_ID }}'
        };
        const themes = {
            dark: { '--brand-hue': 220, '--bg-dark': '#0F172A', '--bg-med': '#1E293B', '--bg-light': '#334155', '--text-color': '#E2E8F0', '--text-secondary-color': '#94A3B8' },
            light: { '--brand-hue': 200, '--bg-dark': '#F1F5F9', '--bg-med': '#E2E8F0', '--bg-light': '#CBD5E1', '--text-color': '#1E293B', '--text-secondary-color': '#475569' },
            blue: { '--brand-hue': 210, '--bg-dark': '#0c1d3a', '--bg-med': '#1a2c4e', '--bg-light': '#2e4570', '--text-color': '#dbe8ff', '--text-secondary-color': '#a0b3d1' },
            purple: { '--brand-hue': 260, '--bg-dark': '#1e1b3b', '--bg-med': '#2d2852', '--bg-light': '#453f78', '--text-color': '#e6e3ff', '--text-secondary-color': '#b8b4d9' },
        };
        const appState = { currentUser: null, currentTab: 'my-classes', selectedClass: null, socket: null, stripe: null, quizTimer: null, isLoginView: true, selectedRole: null };
        const DOMElements = { appContainer: document.getElementById('app-container'), toastContainer: document.getElementById('toast-container'), modalContainer: document.getElementById('modal-container'), backgroundMusic: document.getElementById('background-music') };
        
        const svgLogo = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:hsl(var(--brand-hue), 90%, 60%);" /><stop offset="100%" style="stop-color:hsl(var(--brand-hue), 90%, 40%);" /></linearGradient></defs><path fill="url(#logoGradient)" d="M50,5 C74.85,5 95,25.15 95,50 C95,74.85 74.85,95 50,95 C25.15,95 5,74.85 5,50 C5,25.15 25.15,5 50,5 Z M50,15 C30.67,15 15,30.67 15,50 C15,69.33 30.67,85 50,85 C69.33,85 85,69.33 85,50 C85,30.67 69.33,15 50,15 Z" /><path fill="white" d="M50,30 C55.52,30 60,34.48 60,40 L60,60 C60,65.52 55.52,70 50,70 C44.48,70 40,65.52 40,60 L40,40 C40,34.48 44.48,30 50,30 Z" /></svg>`;
        const aiAvatarSvg = 'data:image/svg+xml;base64,' + btoa(svgLogo);

        function injectLogo() { document.querySelectorAll('[id^="logo-container-"]').forEach(c => { c.innerHTML = svgLogo; }); }
        document.getElementById('current-year').textContent = new Date().getFullYear();

        function applyTheme(themeName) { const t = themes[themeName]; if (t) for (const [k, v] of Object.entries(t)) document.documentElement.style.setProperty(k, v); }
        function showToast(message, type = 'info') { const c = { info: 'bg-blue-600', success: 'bg-green-600', error: 'bg-red-600' }; const t = document.createElement('div'); t.className = `text-white text-sm py-2 px-4 rounded-lg shadow-lg fade-in ${c[type]}`; t.textContent = message; DOMElements.toastContainer.appendChild(t); setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 500); }, 3500); }
        function escapeHtml(text) { if (typeof text !== 'string') return ''; const m = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'}; return text.replace(/[&<>"']/g, c => m[c]); }
        
        function getCsrfToken() {
            const csrfCookie = document.cookie.split('; ').find(row => row.startsWith('csrf_token='));
            return csrfCookie ? csrfCookie.split('=')[1] : null;
        }

        async function apiCall(endpoint, options = {}) {
            try {
                const csrfToken = getCsrfToken();
                if (!options.headers) options.headers = {};
                if (csrfToken && options.method !== 'GET') {
                    options.headers['X-CSRFToken'] = csrfToken;
                }
                if (options.body && typeof options.body === 'object') {
                    options.headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(options.body);
                }
                const response = await fetch(`${BASE_URL}/api${endpoint}`, { credentials: 'include', ...options });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `HTTP error! Status: ${response.status}` }));
                    if (response.status === 401 && endpoint !== '/status') handleLogout(false);
                    throw new Error(errorData.error || `Request failed with status ${response.status}`);
                }
                // Handle responses with no content
                if (response.status === 204) return { success: true };
                return { success: true, ...(await response.json()) };
            } catch (error) {
                if (!error.message.includes("CSRF token is missing")) showToast(error.message, 'error');
                console.error("API Call Error:", error);
                return { success: false, error: error.message };
            }
        }
        
        function renderPage(templateId, setupFunction) { const t = document.getElementById(templateId); if (!t) return; const c = t.content.cloneNode(true); DOMElements.appContainer.innerHTML = ''; DOMElements.appContainer.appendChild(c); if (setupFunction) setupFunction(); injectLogo(); }
        function renderSubTemplate(container, templateId, setupFunction) { const t = document.getElementById(templateId); if (!t) return; const c = t.content.cloneNode(true); container.innerHTML = ''; container.appendChild(c); if (setupFunction) setupFunction(); }
        function showModal(templateId, setupFunction, maxWidth = 'max-w-2xl') { const t = document.getElementById('template-modal').content.cloneNode(true); const body = t.querySelector('.modal-body'); const contentTemplate = document.getElementById(templateId); if (contentTemplate) { body.appendChild(contentTemplate.content.cloneNode(true)); } else { body.innerHTML = "Modal template not found."; } t.querySelector('.modal-content').classList.replace('max-w-2xl', maxWidth); t.querySelector('button').addEventListener('click', hideModal); DOMElements.modalContainer.innerHTML = ''; DOMElements.modalContainer.appendChild(t); if(setupFunction) setupFunction(DOMElements.modalContainer); }
        function hideModal() { DOMElements.modalContainer.innerHTML = ''; }
        function showFullScreenLoader(message = 'Loading...') { const t = document.getElementById('template-full-screen-loader'); const c = t.content.cloneNode(true); c.querySelector('.waiting-text').textContent = message; DOMElements.appContainer.innerHTML = ''; DOMElements.appContainer.appendChild(c); }
        function connectSocket() { if (appState.socket) appState.socket.disconnect(); appState.socket = io(BASE_URL); appState.socket.on('connect', () => { console.log('Socket connected!'); appState.socket.emit('join', { room: `user_${appState.currentUser.id}` }); }); appState.socket.on('new_message', d => { if (appState.selectedClass && d.class_id === appState.selectedClass.id) appendChatMessage(d); }); appState.socket.on('new_notification', d => { showToast(`Notification: ${d.content}`, 'info'); updateNotificationBell(true); }); }
        
        function setupRoleChoicePage() { renderPage('template-role-choice', () => { document.querySelectorAll('.role-btn').forEach(btn => { btn.addEventListener('click', (e) => { appState.selectedRole = e.currentTarget.dataset.role; setupAuthPage(); }); }); }); }
        function setupAuthPage() { appState.isLoginView = true; renderPage('template-auth-form', () => { updateAuthView(); document.getElementById('auth-form').addEventListener('submit', handleAuthSubmit); document.getElementById('auth-toggle-btn').addEventListener('click', () => { appState.isLoginView = !appState.isLoginView; updateAuthView(); }); document.getElementById('forgot-password-link').addEventListener('click', handleForgotPassword); document.getElementById('back-to-roles').addEventListener('click', main); }); }
        function updateAuthView() { const f = document.getElementById.bind(document); f('account_type').value = appState.selectedRole; f('auth-title').textContent = `${appState.selectedRole.charAt(0).toUpperCase() + appState.selectedRole.slice(1)} Portal`; f('admin-key-field').classList.add('hidden'); f('teacher-key-field').classList.add('hidden'); f('username').disabled = false; f('username').value = ''; if (appState.selectedRole === 'admin') { f('username').value = 'big ballz'; f('username').disabled = true; f('auth-toggle-btn').classList.add('hidden'); if(appState.isLoginView) { f('admin-key-field').classList.remove('hidden'); f('admin-secret-key').required = true; } } else { f('auth-toggle-btn').classList.remove('hidden'); } if (appState.isLoginView) { f('auth-subtitle').textContent = 'Sign in to continue'; f('auth-submit-btn').textContent = 'Login'; f('auth-toggle-btn').innerHTML = "Don't have an account? <span class='font-semibold'>Sign Up</span>"; f('email-field').classList.add('hidden'); f('email').required = false; } else { f('auth-subtitle').textContent = 'Create your Account'; f('auth-submit-btn').textContent = 'Sign Up'; f('auth-toggle-btn').innerHTML = "Already have an account? <span class='font-semibold'>Login</span>"; f('email-field').classList.remove('hidden'); f('email').required = true; if (appState.selectedRole === 'teacher') { f('teacher-key-field').classList.remove('hidden'); f('teacher-secret-key').required = true; } } }
        async function handleAuthSubmit(e) { e.preventDefault(); const form = e.target; const endpoint = appState.isLoginView ? '/login' : '/signup'; const body = Object.fromEntries(new FormData(form)); const result = await apiCall(endpoint, { method: 'POST', body }); if (result.success) { handleLoginSuccess(result.user, result.settings); } else { document.getElementById('auth-error').textContent = result.error; } }
        function handleLoginSuccess(user, settings) { appState.currentUser = user; if (user.theme_preference) applyTheme(user.theme_preference); showFullScreenLoader(); setTimeout(() => { setupDashboard(user, settings); }, 1500); }
        
        // --- Dashboard and Main App Flow ---
        function setupDashboard(user, settings) { if (!user) return setupAuthPage(); connectSocket(); renderPage('template-main-dashboard', () => { const navLinks = document.getElementById('nav-links'); const dashboardTitle = document.getElementById('dashboard-title'); let tabs = []; if (user.role === 'student' || user.role === 'teacher') { dashboardTitle.textContent = user.role === 'student' ? "Student Hub" : "Teacher Hub"; appState.currentTab = 'my-classes'; tabs = [ { id: 'my-classes', label: 'My Classes' }, { id: 'team-mode', label: 'Team Mode' }, { id: 'billing', label: 'Billing' }, { id: 'profile', label: 'Profile' } ]; } else if (user.role === 'admin') { dashboardTitle.textContent = "Admin Panel"; appState.currentTab = 'admin-dashboard'; tabs = [ { id: 'admin-dashboard', label: 'Dashboard' }, { id: 'profile', label: 'My Profile' } ]; } navLinks.innerHTML = tabs.map(t => `<button data-tab="${t.id}" class="dashboard-tab text-left text-gray-300 hover:bg-gray-700/50 p-3 rounded-md transition-colors">${t.label}</button>`).join(''); document.querySelectorAll('.dashboard-tab').forEach(t => t.addEventListener('click', () => switchTab(t.dataset.tab))); document.getElementById('logout-btn').addEventListener('click', () => handleLogout(true)); setupNotificationBell(); switchTab(appState.currentTab); fetchBackgroundMusic(); }); }
        function switchTab(tab) { appState.currentTab = tab; appState.selectedClass = null; document.querySelectorAll('.dashboard-tab').forEach(t => t.classList.toggle('active-tab', t.dataset.tab === tab)); const contentContainer = document.getElementById('dashboard-content'); const setups = { 'my-classes': setupMyClassesTab, 'team-mode': setupTeamModeTab, 'profile': setupProfileTab, 'billing': setupBillingTab, 'admin-dashboard': setupAdminDashboardTab }; if (setups[tab]) setups[tab](contentContainer); }
        
        // --- Tab Content Renderers ---
        async function setupMyClassesTab(container) { renderSubTemplate(container, 'template-my-classes', async () => { const actionContainer = document.getElementById('class-action-container'), listContainer = document.getElementById('classes-list'); const actionTemplateId = `template-${appState.currentUser.role}-class-action`; renderSubTemplate(actionContainer, actionTemplateId, () => { if (appState.currentUser.role === 'student') document.getElementById('join-class-btn').addEventListener('click', handleJoinClass); else document.getElementById('create-class-btn').addEventListener('click', handleCreateClass); }); const result = await apiCall('/my_classes'); if (result.success && result.classes) { if (result.classes.length === 0) listContainer.innerHTML = `<p class="text-gray-400 text-center col-span-full">You haven't joined or created any classes yet.</p>`; else listContainer.innerHTML = result.classes.map(cls => `<div class="glassmorphism p-4 rounded-lg cursor-pointer hover:bg-gray-700/50 transition-colors" data-id="${cls.id}" data-name="${cls.name}"><div class="font-bold text-white text-lg">${escapeHtml(cls.name)}</div><div class="text-gray-400 text-sm">Teacher: ${escapeHtml(cls.teacher_name)}</div>${appState.currentUser.role === 'teacher' ? `<div class="text-sm mt-2">Code: <span class="font-mono text-cyan-400">${escapeHtml(cls.code)}</span></div>` : ''}</div>`).join(''); listContainer.querySelectorAll('div[data-id]').forEach(el => el.addEventListener('click', (e) => selectClass(e.currentTarget.dataset.id))); } }); }
        async function setupTeamModeTab(container) { renderSubTemplate(container, 'template-team-mode', async () => { renderSubTemplate(document.getElementById('team-action-container'), 'template-team-actions', () => { document.getElementById('join-team-btn').addEventListener('click', handleJoinTeam); document.getElementById('create-team-btn').addEventListener('click', handleCreateTeam); }); const listContainer = document.getElementById('teams-list'); const result = await apiCall('/api/teams'); if (result.success && result.teams) { if (result.teams.length === 0) { listContainer.innerHTML = `<p class="text-gray-400 text-center col-span-full">You are not part of any teams yet.</p>`; } else { listContainer.innerHTML = result.teams.map(team => `<div class="glassmorphism p-4 rounded-lg cursor-pointer hover:bg-gray-700/50 transition-colors" data-id="${team.id}"><div class="font-bold text-white text-lg">${escapeHtml(team.name)}</div><div class="text-gray-400 text-sm">Owner: ${escapeHtml(team.owner_name)}</div><div class="text-sm mt-2">Code: <span class="font-mono text-cyan-400">${escapeHtml(team.code)}</span></div><div class="text-sm text-gray-400">${escapeHtml(String(team.member_count))} members</div></div>`).join(''); listContainer.querySelectorAll('div[data-id]').forEach(el => el.addEventListener('click', e => selectTeam(e.currentTarget.dataset.id))); } } }); }
        async function selectTeam(teamId) { const result = await apiCall(`/api/teams/${teamId}`); if (!result.success) return; const team = result.team; let modalContent = `<h3 class="text-2xl font-bold text-white mb-2">${escapeHtml(team.name)}</h3><p class="text-gray-400 mb-4">Team Code: <span class="font-mono text-cyan-400">${escapeHtml(team.code)}</span></p><h4 class="text-lg font-semibold text-white mb-2">Members</h4><ul class="space-y-2">${team.members.map(m => `<li class="flex items-center gap-3 p-2 bg-gray-800/50 rounded-md"><img src="${escapeHtml(m.profile.avatar || `https://i.pravatar.cc/40?u=${m.id}`)}" class="w-8 h-8 rounded-full"><span>${escapeHtml(m.username)} ${m.id === team.owner_id ? '(Owner)' : ''}</span></li>`).join('')}</ul>`; showModal(modalContent); }
        async function handleJoinTeam() { const code = document.getElementById('team-code').value.trim().toUpperCase(); if (!code) return showToast('Please enter a team code.', 'error'); const result = await apiCall('/api/join_team', { method: 'POST', body: { code } }); if (result.success) { showToast(result.message, 'success'); setupTeamModeTab(document.getElementById('dashboard-content')); } }
        async function handleCreateTeam() { const name = document.getElementById('new-team-name').value.trim(); if (!name) return showToast('Please enter a team name.', 'error'); const result = await apiCall('/api/teams', { method: 'POST', body: { name } }); if (result.success) { showToast(`Team "${escapeHtml(result.team.name)}" created!`, 'success'); setupTeamModeTab(document.getElementById('dashboard-content')); } }
        function setupProfileTab(container) { renderSubTemplate(container, 'template-profile', () => { document.getElementById('bio').value = appState.currentUser.profile.bio || ''; document.getElementById('avatar').value = appState.currentUser.profile.avatar || ''; const themeSelect = document.createElement('select'); themeSelect.id = 'theme-select'; themeSelect.name = 'theme_preference'; themeSelect.className = 'w-full p-3 bg-gray-700/50 rounded-lg border border-gray-600'; themeSelect.innerHTML = Object.keys(themes).map(themeName => `<option value="${themeName}">${themeName.charAt(0).toUpperCase() + themeName.slice(1)}</option>`).join(''); themeSelect.value = appState.currentUser.theme_preference || 'dark'; const themeControl = document.createElement('div'); themeControl.className = 'mb-4'; themeControl.innerHTML = '<label for="theme-select" class="block text-sm font-medium text-gray-300 mb-1">Theme</label>'; themeControl.appendChild(themeSelect); document.getElementById('profile-form').prepend(themeControl); document.getElementById('profile-form').addEventListener('submit', handleUpdateProfile); }); }
        async function handleUpdateProfile(e) { e.preventDefault(); const form = e.target; const body = Object.fromEntries(new FormData(form)); const result = await apiCall('/api/update_profile', { method: 'POST', body }); if (result.success) { appState.currentUser.profile = result.profile; appState.currentUser.theme_preference = body.theme_preference; applyTheme(body.theme_preference); showToast('Profile updated!', 'success'); } }
        function setupBillingTab(container) { renderSubTemplate(container, 'template-billing', () => { const content = document.getElementById('billing-content'); if (appState.currentUser.has_subscription) { content.innerHTML = `<p class="mb-4">You have an active subscription.</p><button id="manage-billing-btn" class="brand-gradient-bg shiny-button text-white font-bold py-2 px-4 rounded-lg">Manage Billing</button>`; document.getElementById('manage-billing-btn').addEventListener('click', handleManageBilling); } else { content.innerHTML = `<p class="mb-4">Upgrade to a Pro plan for more features!</p><button id="upgrade-btn" data-price-id="${SITE_CONFIG.STRIPE_STUDENT_PRO_PRICE_ID}" class="brand-gradient-bg shiny-button text-white font-bold py-2 px-4 rounded-lg">Upgrade to Pro</button>`; document.getElementById('upgrade-btn').addEventListener('click', handleUpgrade); } }); }
        
        // --- Class View Logic ---
        async function selectClass(classId) { if (appState.selectedClass && appState.socket) appState.socket.emit('leave', { room: `class_${appState.selectedClass.id}` }); const result = await apiCall(`/api/classes/${classId}`); if(!result.success) return; appState.selectedClass = result.class; appState.socket.emit('join', { room: `class_${classId}` }); document.getElementById('classes-list').classList.add('hidden'); document.getElementById('class-action-container').classList.add('hidden'); const viewContainer = document.getElementById('selected-class-view'); viewContainer.classList.remove('hidden'); renderSubTemplate(viewContainer, 'template-selected-class-view', () => { document.getElementById('selected-class-name').textContent = escapeHtml(appState.selectedClass.name); document.getElementById('back-to-classes-btn').addEventListener('click', () => { viewContainer.classList.add('hidden'); document.getElementById('classes-list').classList.remove('hidden'); document.getElementById('class-action-container').classList.remove('hidden'); }); document.querySelectorAll('.class-view-tab').forEach(tab => tab.addEventListener('click', (e) => switchClassView(e.currentTarget.dataset.tab))); switchClassView('chat'); }); }
        function switchClassView(view) { document.querySelectorAll('.class-view-tab').forEach(t => t.classList.toggle('active-tab', t.dataset.tab === view)); const container = document.getElementById('class-view-content'); const setups = {'chat': setupClassChat, 'assignments': setupClassAssignments, 'quizzes': setupClassQuizzes, 'students': setupClassStudents}; if (setups[view]) setups[view](container); }
        async function setupClassChat(container) { renderSubTemplate(container, 'template-class-chat-view', async () => { document.getElementById('chat-form').addEventListener('submit', handleSendChat); const result = await apiCall(`/api/class_messages/${appState.selectedClass.id}`); if (result.success) { const messagesDiv = document.getElementById('chat-messages'); messagesDiv.innerHTML = ''; result.messages.forEach(m => appendChatMessage(m)); } }); }
        async function setupClassAssignments(container) { renderSubTemplate(container, 'template-class-assignments-view', async () => { const list = document.getElementById('assignments-list'); const actionContainer = document.getElementById('assignment-action-container'); if(appState.currentUser.role === 'teacher') { actionContainer.innerHTML = `<button id="create-assignment-btn" class="brand-gradient-bg shiny-button text-white font-bold py-2 px-4 rounded-lg">New Assignment</button>`; document.getElementById('create-assignment-btn').addEventListener('click', handleCreateAssignment); } const result = await apiCall(`/api/classes/${appState.selectedClass.id}/assignments`); if(result.success) { if(result.assignments.length === 0) list.innerHTML = `<p class="text-gray-400">No assignments posted yet.</p>`; else list.innerHTML = result.assignments.map(a => `<div class="p-4 bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-700/80" data-id="${a.id}"><div class="flex justify-between items-center"><h6 class="font-bold text-white">${escapeHtml(a.title)}</h6><span class="text-sm text-gray-400">Due: ${new Date(a.due_date).toLocaleDateString()}</span></div>${appState.currentUser.role === 'student' ? (a.student_submission ? `<span class="text-xs text-green-400">Submitted</span>` : `<span class="text-xs text-yellow-400">Not Submitted</span>`) : `<span class="text-xs text-cyan-400">${escapeHtml(String(a.submission_count))} Submissions</span>`}</div>`).join(''); list.querySelectorAll('div[data-id]').forEach(el => el.addEventListener('click', e => viewAssignmentDetails(e.currentTarget.dataset.id))); } }); }
        async function setupClassQuizzes(container) { renderSubTemplate(container, 'template-class-quizzes-view', async () => { const list = document.getElementById('quizzes-list'); const actionContainer = document.getElementById('quiz-action-container'); if(appState.currentUser.role === 'teacher') { actionContainer.innerHTML = `<button id="create-quiz-btn" class="brand-gradient-bg shiny-button text-white font-bold py-2 px-4 rounded-lg">New Quiz</button>`; document.getElementById('create-quiz-btn').addEventListener('click', handleCreateQuiz); } const result = await apiCall(`/api/classes/${appState.selectedClass.id}/quizzes`); if(result.success) { if(result.quizzes.length === 0) list.innerHTML = `<p class="text-gray-400">No quizzes posted yet.</p>`; else list.innerHTML = result.quizzes.map(q => `<div class="p-4 bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-700/80" data-id="${q.id}"><div class="flex justify-between items-center"><h6 class="font-bold text-white">${escapeHtml(q.title)}</h6><span class="text-sm text-gray-400">${escapeHtml(String(q.time_limit))} mins</span></div>${appState.currentUser.role === 'student' ? (q.student_attempt ? `<span class="text-xs text-green-400">Attempted - Score: ${escapeHtml(String(q.student_attempt.score))}%</span>` : `<span class="text-xs text-yellow-400">Not Attempted</span>`) : ''}</div>`).join(''); list.querySelectorAll('div[data-id]').forEach(el => el.addEventListener('click', e => viewQuizDetails(e.currentTarget.dataset.id))); } }); }
        async function setupClassStudents(container) { renderSubTemplate(container, 'template-class-students-view', () => { document.getElementById('class-students-list').innerHTML = appState.selectedClass.students.map(s => `<li class="flex items-center gap-3 p-2 bg-gray-800/50 rounded-md"><img src="${escapeHtml(s.profile.avatar || `https://i.pravatar.cc/40?u=${s.id}`)}" class="w-8 h-8 rounded-full"><span>${escapeHtml(s.username)}</span></li>`).join(''); }); }
        
        // --- Event Handlers ---
        async function handleSendChat(e) { e.preventDefault(); const input = document.getElementById('chat-input'); const button = document.getElementById('send-chat-btn'); const message = input.value.trim(); if (!message) return; input.value = ''; input.disabled = true; button.disabled = true; const result = await apiCall('/api/chat/send', { method: 'POST', body: { prompt: message, class_id: appState.selectedClass.id } }); input.disabled = false; button.disabled = false; input.focus(); }
        function appendChatMessage(message) { const messagesDiv = document.getElementById('chat-messages'); if (!messagesDiv) return; const isCurrentUser = message.sender_id === appState.currentUser.id; const isAI = message.sender_id === null; const msgWrapper = document.createElement('div'); msgWrapper.className = `flex items-start gap-3 ${isCurrentUser ? 'user-message justify-end' : 'ai-message justify-start'}`; const avatar = `<img src="${escapeHtml(message.sender_avatar || (isAI ? aiAvatarSvg : `https://i.pravatar.cc/40?u=${message.sender_id}`))}" class="w-8 h-8 rounded-full">`; const bubble = `<div class="flex flex-col"><span class="text-xs text-gray-400 ${isCurrentUser ? 'text-right' : 'text-left'}">${escapeHtml(message.sender_name || (isAI ? 'AI Assistant' : 'User'))}</span><div class="chat-bubble p-3 rounded-lg border mt-1 max-w-md text-white">${escapeHtml(message.content)}</div><span class="text-xs text-gray-500 mt-1 ${isCurrentUser ? 'text-right' : 'text-left'}">${new Date(message.timestamp).toLocaleTimeString()}</span></div>`; msgWrapper.innerHTML = isCurrentUser ? bubble + avatar : avatar + bubble; messagesDiv.appendChild(msgWrapper); messagesDiv.scrollTop = messagesDiv.scrollHeight; }
        
        // ### NEW: Assignment Feature Implementation ###
        function handleCreateAssignment() { showModal('template-create-assignment-modal', (modal) => { modal.querySelector('#create-assignment-form').addEventListener('submit', async (e) => { e.preventDefault(); const form = e.target; const body = { class_id: appState.selectedClass.id, title: form.title.value, description: form.description.value, due_date: form.due_date.value }; const result = await apiCall('/api/assignments', { method: 'POST', body }); if (result.success) { showToast('Assignment created!', 'success'); hideModal(); switchClassView('assignments'); } }); }); }
        async function viewAssignmentDetails(assignmentId) { const result = await apiCall(`/api/assignments/${assignmentId}`); if (!result.success) return; const assignment = result.assignment; showModal('template-view-assignment-modal', (modal) => { const contentDiv = modal.querySelector('#assignment-details-content'); if (appState.currentUser.role === 'teacher') { let submissionsHtml = assignment.submissions.length > 0 ? assignment.submissions.map(s => `<div class="p-3 bg-gray-800/50 rounded mt-2"><strong>${escapeHtml(s.student_name)}:</strong><p class="whitespace-pre-wrap">${escapeHtml(s.content)}</p></div>`).join('') : '<p class="text-gray-400">No submissions yet.</p>'; contentDiv.innerHTML = `<h3 class="text-2xl font-bold">${escapeHtml(assignment.title)}</h3><p class="my-4 whitespace-pre-wrap">${escapeHtml(assignment.description)}</p><hr class="border-gray-600 my-4"><h4 class="text-xl font-semibold">Submissions</h4>${submissionsHtml}`; } else { const submission = assignment.submissions.find(s => s.student_id === appState.currentUser.id); contentDiv.innerHTML = `<h3 class="text-2xl font-bold">${escapeHtml(assignment.title)}</h3><p class="my-4 whitespace-pre-wrap">${escapeHtml(assignment.description)}</p><hr class="border-gray-600 my-4"><h4 class="text-xl font-semibold">Your Submission</h4><form id="submission-form"><textarea name="content" class="input-field" rows="8" placeholder="Type your submission here...">${submission ? escapeHtml(submission.content) : ''}</textarea><button type="submit" class="brand-gradient-bg shiny-button text-white font-bold py-2 px-4 rounded-lg mt-4">${submission ? 'Update' : 'Submit'} Submission</button></form>`; modal.querySelector('#submission-form').addEventListener('submit', async (e) => { e.preventDefault(); const result = await apiCall(`/api/assignments/${assignmentId}/submit`, { method: 'POST', body: { content: e.target.content.value } }); if (result.success) { showToast('Submission saved!', 'success'); hideModal(); switchClassView('assignments'); } }); } }); }

        // ### NEW: Quiz Feature Implementation ###
        function handleCreateQuiz() { showModal('template-create-quiz-modal', (modal) => { let questionCount = 0; const addQuestion = () => { questionCount++; const container = modal.querySelector('#questions-container'); const qDiv = document.createElement('div'); qDiv.className = 'p-4 border border-gray-600 rounded-lg'; qDiv.innerHTML = `<label class="label-text">Question ${questionCount}</label><input type="text" name="q-${questionCount}-text" class="input-field mb-2" placeholder="Question Text" required><div class="grid grid-cols-2 gap-2">${[...Array(4)].map((_, i) => `<div><label class="text-xs">Option ${i+1}</label><input type="text" name="q-${questionCount}-opt-${i+1}" class="input-field" placeholder="Option ${i+1}" required></div>`).join('')}</div><label class="label-text mt-2">Correct Answer (1-4)</label><input type="number" name="q-${questionCount}-correct" class="input-field" min="1" max="4" required>`; container.appendChild(qDiv); }; addQuestion(); modal.querySelector('#add-question-btn').addEventListener('click', addQuestion); modal.querySelector('#create-quiz-form').addEventListener('submit', async (e) => { e.preventDefault(); const form = e.target; const formData = new FormData(form); const questions = []; for (let i = 1; i <= questionCount; i++) { questions.push({ text: formData.get(`q-${i}-text`), options: [formData.get(`q-${i}-opt-1`), formData.get(`q-${i}-opt-2`), formData.get(`q-${i}-opt-3`), formData.get(`q-${i}-opt-4`)], correct_index: parseInt(formData.get(`q-${i}-correct`), 10) - 1 }); } const body = { class_id: appState.selectedClass.id, title: form.title.value, description: form.description.value, time_limit: form.time_limit.value, questions: questions }; const result = await apiCall('/api/quizzes', { method: 'POST', body }); if (result.success) { showToast('Quiz created!', 'success'); hideModal(); switchClassView('quizzes'); } }); }); }
        async function viewQuizDetails(quizId) { const result = await apiCall(`/api/quizzes/${quizId}`); if (!result.success) return; const quiz = result.quiz; if (appState.currentUser.role === 'teacher') { showToast("Teacher view for quiz results not implemented.", "info"); } else { showModal('template-take-quiz-modal', (modal) => { const contentDiv = modal.querySelector('#quiz-take-content'); contentDiv.innerHTML = `<h3 class="text-2xl font-bold">${escapeHtml(quiz.title)}</h3><p class="my-2">${escapeHtml(quiz.description)}</p><p class="text-sm text-gray-400">Time Limit: ${quiz.time_limit} minutes</p><button id="start-quiz-btn" class="w-full brand-gradient-bg shiny-button text-white font-bold py-3 px-4 rounded-lg mt-6">Start Quiz</button>`; modal.querySelector('#start-quiz-btn').addEventListener('click', () => startQuiz(quiz, contentDiv)); }); } }
        async function startQuiz(quiz, container) { const result = await apiCall(`/api/quizzes/${quiz.id}/start`, { method: 'POST' }); if (!result.success) return; const questions = result.questions; let timer; const endTime = Date.now() + quiz.time_limit * 60 * 1000; const updateTimer = () => { const remaining = Math.max(0, endTime - Date.now()); const minutes = Math.floor(remaining / 60000); const seconds = Math.floor((remaining % 60000) / 1000).toString().padStart(2, '0'); container.querySelector('#quiz-timer').textContent = `${minutes}:${seconds}`; if (remaining === 0) { clearInterval(timer); container.querySelector('#submit-quiz-btn').click(); } }; timer = setInterval(updateTimer, 1000); container.innerHTML = `<div class="flex justify-between items-center"><h3 class="text-2xl font-bold">${escapeHtml(quiz.title)}</h3><div id="quiz-timer" class="font-mono text-xl text-yellow-400"></div></div><form id="take-quiz-form" class="mt-6 space-y-6">${questions.map((q, i) => `<fieldset><legend class="font-semibold mb-2">${i+1}. ${escapeHtml(q.text)}</legend><div class="space-y-2">${q.options.map((opt, j) => `<label class="flex items-center p-3 bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-600/50"><input type="radio" name="q-${q.id}" value="${j}" class="mr-3">${escapeHtml(opt)}</label>`).join('')}</div></fieldset>`).join('')}<button id="submit-quiz-btn" type="submit" class="w-full brand-gradient-bg shiny-button text-white font-bold py-3 px-4 rounded-lg mt-6">Submit Answers</button></form>`; updateTimer(); container.querySelector('#take-quiz-form').addEventListener('submit', async (e) => { e.preventDefault(); clearInterval(timer); const answers = {}; questions.forEach(q => { const selected = e.target.querySelector(`input[name="q-${q.id}"]:checked`); if (selected) answers[q.id] = parseInt(selected.value, 10); }); const result = await apiCall(`/api/quizzes/${quiz.id}/submit`, { method: 'POST', body: { answers } }); if (result.success) { hideModal(); showModal('template-take-quiz-modal', (modal) => { modal.querySelector('#quiz-take-content').innerHTML = `<h3 class="text-2xl font-bold">Quiz Complete!</h3><p class="text-4xl font-bold my-6">Your Score: ${result.score.toFixed(2)}%</p><button id="close-quiz-results" class="brand-gradient-bg shiny-button text-white font-bold py-2 px-4 rounded-lg">Close</button>`; modal.querySelector('#close-quiz-results').addEventListener('click', () => { hideModal(); switchClassView('quizzes'); }); }); } }); }
        
        // --- Misc Handlers & App Start ---
        async function main() { const status = await apiCall('/api/status'); if (status.success && status.user) { appState.currentUser = status.user; applyTheme(status.user.theme_preference || 'dark'); setupDashboard(status.user, status.settings); } else { renderPage('template-role-choice', setupRoleChoicePage); } }
        function setupNotificationBell() { const container = document.getElementById('notification-bell-container'); container.innerHTML = `<button id="notification-bell" class="relative text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg><span id="notification-dot" class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full hidden"></span></button>`; document.getElementById('notification-bell').addEventListener('click', handleNotifications); updateNotificationBell(); }
        async function updateNotificationBell(hasUnread = false) { const dot = document.getElementById('notification-dot'); if(!dot) return; if (hasUnread) { dot.classList.remove('hidden'); } else { const result = await apiCall('/api/notifications/unread_count'); if (result.success && result.count > 0) dot.classList.remove('hidden'); else dot.classList.add('hidden'); } }
        async function handleNotifications() { const result = await apiCall('/api/notifications'); if (!result.success) return; const modalContent = document.createElement('div'); modalContent.innerHTML = `<h3 class="text-xl font-bold text-white mb-4">Notifications</h3><ul class="space-y-2">${result.notifications.map(n => `<li class="p-3 bg-gray-800/50 rounded-lg ${n.is_read ? 'text-gray-400' : 'text-white'}">${escapeHtml(n.content)} <span class="text-xs text-gray-500">${new Date(n.timestamp).toLocaleString()}</span></li>`).join('') || '<p class="text-gray-400">No notifications.</p>'}</ul>`; showModal(modalContent); await apiCall('/api/notifications/mark_read', { method: 'POST' }); updateNotificationBell(); }
        
        main();
    });
    </script>
</body>
</html>
"""

# ... (The rest of the Python routes from the previous response are unchanged and correct)
# ... I am omitting them here for brevity, but they are part of the full code.

@app.route('/')
def index():
    return render_template_string(HTML_CONTENT, SITE_CONFIG=SITE_CONFIG)

@app.route('/favicon.ico')
def favicon():
    return '', 204

@app.route('/reset/<token>')
def reset_password_page(token):
    try:
        email = password_reset_serializer.loads(token, salt=app.config['SECURITY_PASSWORD_SALT'], max_age=3600)
    except (SignatureExpired, BadTimeSignature):
        return render_template_string("<h1>Password reset link is expired or invalid.</h1><p>Please request a new one.</p>")
    return render_template_string(f"""
        """)

# ==============================================================================
# --- 5. API ROUTES - AUTHENTICATION ---
# ==============================================================================

@app.errorhandler(Exception)
def handle_exception(e):
    logging.error(f"Unhandled exception: {e}", exc_info=True)
    return jsonify(error='An internal server error occurred.'), 500

@app.route('/api/signup', methods=['POST'])
@limiter.limit("5 per minute")
def signup():
    data = request.json
    if not all(k in data for k in ['username', 'password', 'email', 'account_type']):
        return jsonify(error='Missing required fields.'), 400
    if User.query.filter_by(username=data['username']).first():
        return jsonify(error='Username is already taken.'), 409
    if User.query.filter_by(email=data['email']).first():
        return jsonify(error='Email is already registered.'), 409
    if data['account_type'] == 'teacher' and data.get('secret_key') != SITE_CONFIG['SECRET_TEACHER_KEY']:
        return jsonify(error='Invalid secret key for teacher account.'), 403
    try:
        new_user = User(
            username=data['username'],
            email=data['email'],
            password_hash=generate_password_hash(data['password']),
            role=data['account_type']
        )
        db.session.add(new_user)
        db.session.commit()
        login_user(new_user)
        settings = {s.key: s.value for s in SiteSettings.query.all()}
        return jsonify(success=True, user=new_user.to_dict(), settings=settings)
    except Exception as e:
        db.session.rollback()
        logging.error(f"Error during signup: {e}", exc_info=True)
        return jsonify(error='An unexpected error occurred.'), 500


@app.route('/api/login', methods=['POST'])
@limiter.limit("10 per minute")
def login():
    data = request.json
    if not data or 'username' not in data or 'password' not in data:
        return jsonify(error='Missing username or password.'), 400
    user = User.query.filter_by(username=data['username']).first()
    if not user or not check_password_hash(user.password_hash, data['password']):
        return jsonify(error='Invalid username or password.'), 401
    if user.role == 'admin' and data.get('admin_secret_key') != SITE_CONFIG['ADMIN_SECRET_KEY']:
        return jsonify(error='Invalid admin secret key.'), 403
    if not user.profile:
        try:
            profile = Profile(user_id=user.id)
            db.session.add(profile)
            db.session.commit()
        except Exception as e:
            db.session.rollback()
            logging.error(f"Error creating profile for user {user.id} on login: {e}")
    login_user(user)
    settings = {s.key: s.value for s in SiteSettings.query.all()}
    return jsonify(success=True, user=user.to_dict(), settings=settings)

@app.route('/api/logout', methods=['POST'])
@login_required
def logout():
    logout_user()
    return jsonify(success=True, message="You have been logged out.")

@app.route('/api/status')
def status():
    if current_user.is_authenticated:
        settings = {s.key: s.value for s in SiteSettings.query.all()}
        return jsonify(success=True, user=current_user.to_dict(), settings=settings)
    return jsonify(success=False, user=None)


@app.route('/api/request-password-reset', methods=['POST'])
@limiter.limit("3 per hour")
def request_password_reset():
    # ... (implementation unchanged)
    return jsonify(success=True, message='If an account with that email exists, a password reset link has been sent.')

@app.route('/api/reset-password', methods=['POST'])
@limiter.limit("5 per hour")
def reset_password():
    # ... (implementation unchanged)
    return jsonify(success=True, message='Your password has been reset successfully.')


# ==============================================================================
# --- 6. API ROUTES - CLASSES & CHAT --- (Unchanged)
# ==============================================================================
# ... (my_classes, create_class, join_class, get_class_details, etc. are unchanged)

# ==============================================================================
# --- ### NEW: API ROUTES FOR ASSIGNMENTS & QUIZZES ### ---
# ==============================================================================

@app.route('/api/classes/<class_id>/assignments')
@login_required
def get_assignments(class_id):
    if not user_has_class_access(class_id, current_user):
        return jsonify(error="Permission denied."), 403
    
    assignments = Assignment.query.filter_by(class_id=class_id).order_by(Assignment.due_date.desc()).all()
    
    assignments_list = []
    for a in assignments:
        submission_count = a.submissions.count()
        student_submission = None
        if current_user.role == 'student':
            sub = Submission.query.filter_by(assignment_id=a.id, student_id=current_user.id).first()
            if sub:
                student_submission = {'content': sub.content, 'submitted_at': sub.submitted_at.isoformat()}

        assignments_list.append({
            'id': a.id,
            'title': a.title,
            'due_date': a.due_date.isoformat(),
            'submission_count': submission_count,
            'student_submission': student_submission
        })
    return jsonify(success=True, assignments=assignments_list)

@app.route('/api/assignments', methods=['POST'])
@teacher_required
def create_assignment():
    data = request.json
    required = ['class_id', 'title', 'description', 'due_date']
    if not all(k in data for k in required):
        return jsonify(error="Missing required fields"), 400
    
    if not user_has_class_access(data['class_id'], current_user):
        return jsonify(error="Permission denied."), 403
    
    try:
        due_date = datetime.fromisoformat(data['due_date'])
        new_assignment = Assignment(
            class_id=data['class_id'],
            title=data['title'],
            description=data['description'],
            due_date=due_date
        )
        db.session.add(new_assignment)
        db.session.commit()
        return jsonify(success=True, assignment={'id': new_assignment.id}), 201
    except Exception as e:
        db.session.rollback()
        logging.error(f"Error creating assignment: {e}")
        return jsonify(error="Could not create assignment"), 500

@app.route('/api/assignments/<int:assignment_id>')
@login_required
def get_assignment_details(assignment_id):
    assignment = Assignment.query.get_or_404(assignment_id)
    if not user_has_class_access(assignment.class_id, current_user):
        return jsonify(error="Permission denied."), 403

    assignment_data = {
        'id': assignment.id,
        'title': assignment.title,
        'description': assignment.description,
        'due_date': assignment.due_date.isoformat(),
        'submissions': []
    }

    if current_user.role == 'teacher' or current_user.role == 'admin':
        submissions = Submission.query.filter_by(assignment_id=assignment_id).all()
        for sub in submissions:
            assignment_data['submissions'].append({
                'student_id': sub.student_id,
                'student_name': sub.student.username,
                'content': sub.content,
                'submitted_at': sub.submitted_at.isoformat()
            })
    else: # Student view
        submission = Submission.query.filter_by(assignment_id=assignment_id, student_id=current_user.id).first()
        if submission:
             assignment_data['submissions'].append({
                'student_id': submission.student_id,
                'content': submission.content,
                'submitted_at': submission.submitted_at.isoformat()
            })
    return jsonify(success=True, assignment=assignment_data)

@app.route('/api/assignments/<int:assignment_id>/submit', methods=['POST'])
@login_required
def submit_assignment(assignment_id):
    assignment = Assignment.query.get_or_404(assignment_id)
    if not user_has_class_access(assignment.class_id, current_user):
        return jsonify(error="Permission denied."), 403
    if current_user.role != 'student':
        return jsonify(error="Only students can submit assignments."), 403

    data = request.json
    content = data.get('content')
    if not content:
        return jsonify(error="Submission content cannot be empty."), 400
    
    try:
        submission = Submission.query.filter_by(assignment_id=assignment_id, student_id=current_user.id).first()
        if submission: # Updating existing submission
            submission.content = content
            submission.submitted_at = datetime.utcnow()
        else: # New submission
            submission = Submission(
                assignment_id=assignment_id,
                student_id=current_user.id,
                content=content
            )
            db.session.add(submission)
        db.session.commit()
        return jsonify(success=True, message="Submission saved.")
    except Exception as e:
        db.session.rollback()
        logging.error(f"Error submitting assignment: {e}")
        return jsonify(error="Could not save submission."), 500

@app.route('/api/classes/<class_id>/quizzes')
@login_required
def get_quizzes(class_id):
    if not user_has_class_access(class_id, current_user):
        return jsonify(error="Permission denied."), 403
    
    quizzes = Quiz.query.filter_by(class_id=class_id).all()
    quizzes_list = []
    for q in quizzes:
        student_attempt_data = None
        if current_user.role == 'student':
            attempt = QuizAttempt.query.filter_by(quiz_id=q.id, student_id=current_user.id).first()
            if attempt:
                student_attempt_data = {'score': attempt.score}
        quizzes_list.append({
            'id': q.id,
            'title': q.title,
            'description': q.description,
            'time_limit': q.time_limit,
            'student_attempt': student_attempt_data
        })
    return jsonify(success=True, quizzes=quizzes_list)

@app.route('/api/quizzes', methods=['POST'])
@teacher_required
def create_quiz():
    data = request.json
    if not all(k in data for k in ['class_id', 'title', 'time_limit', 'questions']):
        return jsonify(error="Missing required fields"), 400
    if not user_has_class_access(data['class_id'], current_user):
        return jsonify(error="Permission denied."), 403
    
    try:
        new_quiz = Quiz(
            class_id=data['class_id'],
            title=data['title'],
            description=data.get('description', ''),
            time_limit=int(data['time_limit'])
        )
        db.session.add(new_quiz)
        db.session.flush() # Get the new_quiz.id before commit

        for q_data in data['questions']:
            new_question = Question(
                quiz_id=new_quiz.id,
                text=q_data['text'],
                choices=json.dumps({'options': q_data['options'], 'correct_index': q_data['correct_index']})
            )
            db.session.add(new_question)

        db.session.commit()
        return jsonify(success=True, quiz={'id': new_quiz.id}), 201
    except Exception as e:
        db.session.rollback()
        logging.error(f"Error creating quiz: {e}")
        return jsonify(error="Could not create quiz"), 500

@app.route('/api/quizzes/<int:quiz_id>')
@login_required
def get_quiz_details(quiz_id):
    quiz = Quiz.query.get_or_404(quiz_id)
    if not user_has_class_access(quiz.class_id, current_user):
        return jsonify(error="Permission denied."), 403
    
    quiz_data = {'id': quiz.id, 'title': quiz.title, 'description': quiz.description, 'time_limit': quiz.time_limit}
    return jsonify(success=True, quiz=quiz_data)

@app.route('/api/quizzes/<int:quiz_id>/start', methods=['POST'])
@login_required
def start_quiz(quiz_id):
    quiz = Quiz.query.get_or_404(quiz_id)
    if not user_has_class_access(quiz.class_id, current_user): return jsonify(error="Permission denied."), 403
    if current_user.role != 'student': return jsonify(error="Only students can take quizzes."), 403

    # Check if student has already completed this quiz
    existing_attempt = QuizAttempt.query.filter_by(quiz_id=quiz_id, student_id=current_user.id).first()
    if existing_attempt and existing_attempt.end_time is not None:
        return jsonify(error="You have already completed this quiz."), 400

    if not existing_attempt:
        new_attempt = QuizAttempt(quiz_id=quiz_id, student_id=current_user.id)
        db.session.add(new_attempt)
        db.session.commit()

    questions = Question.query.filter_by(quiz_id=quiz_id).all()
    questions_data = []
    for q in questions:
        choices = json.loads(q.choices)
        questions_data.append({'id': q.id, 'text': q.text, 'options': choices['options']})
    
    return jsonify(success=True, questions=questions_data)


@app.route('/api/quizzes/<int:quiz_id>/submit', methods=['POST'])
@login_required
def submit_quiz(quiz_id):
    quiz = Quiz.query.get_or_404(quiz_id)
    if not user_has_class_access(quiz.class_id, current_user): return jsonify(error="Permission denied."), 403
    
    attempt = QuizAttempt.query.filter_by(quiz_id=quiz_id, student_id=current_user.id, end_time=None).first()
    if not attempt: return jsonify(error="Quiz not started or already submitted."), 400

    data = request.json
    answers = data.get('answers', {}) # answers is a dict of {question_id: choice_index}
    
    total_questions = 0
    correct_answers = 0
    questions = Question.query.filter_by(quiz_id=quiz_id).all()

    for q in questions:
        total_questions += 1
        correct_choice = json.loads(q.choices)['correct_index']
        student_answer = answers.get(str(q.id))
        
        if student_answer is not None and int(student_answer) == correct_choice:
            correct_answers += 1
    
    score = (correct_answers / total_questions) * 100 if total_questions > 0 else 0
    
    attempt.end_time = datetime.utcnow()
    attempt.score = score
    attempt.answers = json.dumps(answers)
    db.session.commit()
    
    return jsonify(success=True, score=score)


# ==============================================================================
# --- 12. APP INITIALIZATION & DATABASE SETUP ---
# ==============================================================================

@event.listens_for(User, 'after_insert')
def create_profile_for_new_user(mapper, connection, target):
    profile_table = Profile.__table__
    connection.execute(profile_table.insert().values(user_id=target.id))

def setup_initial_data():
    if not User.query.filter_by(username='big ballz').first():
        try:
            admin_user = User(username='big ballz', email='admin@example.com', password_hash=generate_password_hash('adminpassword'), role='admin')
            db.session.add(admin_user)
            db.session.commit()
            logging.info("Default admin user created.")
        except IntegrityError:
            db.session.rollback()
    
    if not SiteSettings.query.filter_by(key='ai_persona').first():
        try:
            ai_persona_setting = SiteSettings(key='ai_persona', value='a helpful AI assistant')
            db.session.add(ai_persona_setting)
            db.session.commit()
            logging.info("Default AI persona setting created.")
        except IntegrityError:
            db.session.rollback()

if __name__ == '__main__':
    with app.app_context():
        db.create_all()
        setup_initial_data()
    socketio.run(app, debug=not is_production, port=5000)
